<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"> <!-- NOTE: Standard encoding -->
  <title>Invoice - Supermarket App</title> <!-- NOTE: Browser tab title -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- NOTE: Bootstrap CSS -->
</head>
<body>

  <!-- Navbar -->
  <%- include('partials/userNav', { active: (typeof userNavActive !== 'undefined' ? userNavActive : 'orders') }) %>
  <!-- NOTE: If userNavActive exists → highlight it. Else highlight "orders". -->

  <main class="my-4"> <!-- NOTE: Top/bottom margin -->
    <div class="container">

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2>Invoice</h2> <!-- NOTE: Title -->
          <p class="text-muted mb-0">Invoice #: <strong><%= invoiceNumber %></strong></p> <!-- NOTE: Invoice number -->
          <p class="text-muted mb-0">Date: <%= invoiceDate.toLocaleString() %></p> <!-- NOTE: Invoice date/time -->
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" onclick="window.print()">Print</button> <!-- NOTE: Print page -->

          <% const nextLinkValue = (typeof nextLink !== 'undefined' && nextLink) ? nextLink : '/shopping'; %>
          <!-- NOTE: If nextLink passed → use it. Else default to /shopping -->

          <% const nextTextValue = (typeof nextText !== 'undefined' && nextText) ? nextText : 'Continue Shopping'; %>
          <!-- NOTE: If custom button text passed → show it. Else default text -->

          <a href="<%= nextLinkValue %>" class="btn btn-primary"><%= nextTextValue %></a> <!-- NOTE: Continue Button -->
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th> <!-- NOTE: Row number -->
              <th>Product</th>
              <th>Unit Price</th>
              <th>Qty</th>
              <th>Subtotal</th>
            </tr>
          </thead>

          <tbody>
            <% let computedSubtotal = 0; %> <!-- NOTE: Running subtotal -->

            <% cart.forEach(function(item, index) { %> <!-- NOTE: Loop through purchased items -->
              <% const lineSubtotal = item.price * item.quantity; computedSubtotal += lineSubtotal; %>
              <!-- NOTE: Calculate subtotal for each item -->

              <tr>
                <td><%= index + 1 %></td> <!-- NOTE: Row number -->
                <td><%= item.productName %></td> <!-- NOTE: Product name -->
                <td>$<%= item.price.toFixed(2) %></td> <!-- NOTE: Price with 2 decimals -->
                <td><%= item.quantity %></td> <!-- NOTE: Quantity purchased -->
                <td>$<%= lineSubtotal.toFixed(2) %></td> <!-- NOTE: Line subtotal -->
              </tr>

            <% }); %>
          </tbody>

          <tfoot>
            <%
              const invoiceSubtotal = typeof subtotal === 'number' ? subtotal : computedSubtotal;
              /* NOTE: Use controller subtotal if provided, otherwise calculate automatically */

              const invoiceTaxAmount = typeof taxAmount === 'number'
                ? taxAmount
                : Number((invoiceSubtotal * 0.09).toFixed(2));
              /* NOTE: Use provided taxAmount or calculate 9% */

              const invoiceGrandTotal = typeof total === 'number'
                ? total
                : Number((invoiceSubtotal + invoiceTaxAmount).toFixed(2));
              /* NOTE: Total = subtotal + tax */
            %>

            <tr>
              <th colspan="4" class="text-end">Subtotal</th>
              <th>$<%= invoiceSubtotal.toFixed(2) %></th> <!-- NOTE: Subtotal -->
            </tr>
            <tr>
              <th colspan="4" class="text-end">Tax (9%)</th>
              <th>$<%= invoiceTaxAmount.toFixed(2) %></th> <!-- NOTE: GST-like tax -->
            </tr>
            <tr>
              <th colspan="4" class="text-end">Total Due</th>
              <th>$<%= invoiceGrandTotal.toFixed(2) %></th> <!-- NOTE: Final amount -->
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="mt-3">
        <% const backLinkValue = (typeof backLink !== 'undefined' && backLink) ? backLink : '/cart'; %>
        <!-- NOTE: Back link default is /cart -->

        <% const backTextValue = (typeof backText !== 'undefined' && backText) ? backText : 'Back to Cart'; %>
        <!-- NOTE: Back button label default -->

        <a href="<%= backLinkValue %>" class="btn btn-outline-primary"><%= backTextValue %></a>
        <!-- NOTE: Back button -->
      </div>

    </div>
  </main>

  <style>
    html { scroll-behavior: smooth; } /* NOTE: Smooth scroll for long invoices */
    body { min-height: 100vh; display: flex; flex-direction: column; } /* NOTE: Footer stays bottom */
    main { flex: 1 0 auto; }
    footer { flex-shrink: 0; margin-top: auto; }

    .app-footer { background-color: #0b2131; color: #e6edf3; } /* NOTE: Dark footer styling */
    .app-footer a { color: #e6edf3; text-decoration: none; }
    .app-footer a:hover { text-decoration: underline; }

    .app-footer-gradient {
      height: 4px;
      background: linear-gradient(90deg,
        var(--bs-primary, #0d6efd),
        var(--bs-info, #0dcaf0),
        var(--bs-success, #198754),
        var(--bs-warning, #ffc107),
        var(--bs-danger, #dc3545));
    } /* NOTE: Color gradient bar */

    .app-footer-inner { font-size: .95rem; } /* NOTE: Footer text */

    @media print {
      nav, .btn, a.btn { display: none !important; } /* NOTE: Hide navbar + buttons when printing */
      body { margin: 0; } /* NOTE: Clean print layout */
    }
  </style>

  <%- include('partials/footer', { footerClass: '' }) %> <!-- NOTE: Footer include -->
</body>
</html>
