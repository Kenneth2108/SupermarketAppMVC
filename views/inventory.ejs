<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Supermarket App</title>
  <style>
    body { background-color: #f7f7f9; }
    .navbar { box-shadow: 0 2px 6px rgba(0,0,0,.05); }
    .page-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,.06); }
    .page-header { border-bottom: 1px solid #eee; padding-bottom: .75rem; margin-bottom: 1rem; }
    .table thead th { font-size: .85rem; letter-spacing: .02em; text-transform: uppercase; color: #6c757d; }
    .table td, .table th { vertical-align: middle; }
    .product-img { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; background: #fff; }
    .search-input { max-width: 360px; }
  </style>
  <script>
    function imgFallback(img){ img.onerror=null; img.src='/images/placeholder.png'; }
  </script>
</head>
<body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Supermarket App</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="collapsibleNavbar">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/addProduct">Add Product</a>
            </li> 
            <li class="nav-item">
              <a class="nav-link" href="/admin/users">Users</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/users/new">Add User</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/logout">Logout</a>
            </li> 
          </ul>
        </div>
      </div>
    </nav>

  <div class="container my-4">
    <div class="mb-2 text-muted">Welcome, <strong><%= user.username %></strong> (<%= user.role %>)</div>

    <div class="page-card p-4">
      <div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">Products</h2>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="btn-group btn-group-sm me-1" role="group" aria-label="View toggle">
            <button id="viewTableBtn" type="button" class="btn btn-outline-secondary active">Table</button>
            <button id="viewGridBtn" type="button" class="btn btn-outline-secondary">Grid</button>
          </div>
          <input id="productSearch" class="form-control form-control-sm search-input" placeholder="Search products..." />
          <a href="/addProduct" class="btn btn-primary btn-sm">Add Product</a>
        </div>
      </div>

      <div id="inventoryTableSection" class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Product</th>
              <th class="text-center">Image</th>
              <th class="text-center" style="width:140px">Stock</th>
              <th class="text-end" style="width:120px">Price</th>
              <th class="text-center" style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <% if (products && products.length) { %>
              <% products.forEach(function(p){ %>
                <tr>
                  <td>
                    <a class="fw-semibold text-decoration-none" href="/product/<%= p.id %>"><%= p.productName %></a>
                  </td>
                  <td class="text-center">
                    <img class="product-img" src="/images/<%= p.image %>" alt="<%= p.productName %>" onerror="imgFallback(this)">
                  </td>
                  <td class="text-center">
                    <% const q = Number(p.quantity) || 0; %>
                    <% if (q > 20) { %>
                      <span class="badge bg-success">In stock: <%= q %></span>
                    <% } else if (q > 0) { %>
                      <span class="badge bg-warning text-dark">Low: <%= q %></span>
                    <% } else { %>
                      <span class="badge bg-danger">Out</span>
                    <% } %>
                  </td>
                  <td class="text-end">$<%= Number(p.price).toFixed(2) %></td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="/updateProduct/<%= p.id %>" class="btn btn-outline-primary">Edit</a>
                      <a href="/deleteProduct/<%= p.id %>" class="btn btn-outline-danger" onclick="return confirm('Delete <%= p.productName %>?')">Delete</a>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="5" class="text-center text-muted py-5">
                  No products found. <a href="/addProduct">Add your first product</a>.
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <div id="inventoryGridSection" class="d-none">
        <% if (products && products.length) { %>
          <div class="row g-3" id="productGrid">
            <% products.forEach(function(p){ const q = Number(p.quantity) || 0; %>
              <div class="col-12 col-sm-6 col-md-4 col-lg-3 inventory-card">
                <div class="card h-100 shadow-sm">
                  <a href="/product/<%= p.id %>" class="text-decoration-none text-reset">
                    <img src="/images/<%= p.image %>" class="card-img-top" alt="<%= p.productName %>" onerror="imgFallback(this)" style="aspect-ratio:1/1;object-fit:cover;">
                  </a>
                  <div class="card-body">
                    <h6 class="card-title mb-1 text-truncate" title="<%= p.productName %>"><%= p.productName %></h6>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="fw-bold">$<%= Number(p.price).toFixed(2) %></span>
                      <% if (q > 20) { %>
                        <span class="badge bg-success">In stock</span>
                      <% } else if (q > 0) { %>
                        <span class="badge bg-warning text-dark">Low</span>
                      <% } else { %>
                        <span class="badge bg-danger">Out</span>
                      <% } %>
                    </div>
                  </div>
                  <div class="card-footer bg-white border-0 pt-0 d-flex justify-content-between">
                    <a href="/updateProduct/<%= p.id %>" class="btn btn-outline-primary btn-sm">Edit</a>
                    <a href="/deleteProduct/<%= p.id %>" class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete <%= p.productName %>?')">Delete</a>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="text-center text-muted py-5">
            No products found. <a href="/addProduct">Add your first product</a>.
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <script>
    // Simple client-side table filter
    const input = document.getElementById('productSearch');
    const tbody = document.getElementById('productTableBody');
    const tableSection = document.getElementById('inventoryTableSection');
    const gridSection = document.getElementById('inventoryGridSection');
    const viewTableBtn = document.getElementById('viewTableBtn');
    const viewGridBtn = document.getElementById('viewGridBtn');

    function setView(mode){
      const tableActive = mode === 'table';
      tableSection.classList.toggle('d-none', !tableActive);
      gridSection.classList.toggle('d-none', tableActive);
      viewTableBtn.classList.toggle('active', tableActive);
      viewGridBtn.classList.toggle('active', !tableActive);
    }

    if (viewTableBtn && viewGridBtn) {
      viewTableBtn.addEventListener('click', () => setView('table'));
      viewGridBtn.addEventListener('click', () => setView('grid'));
    }

    function filterInventory(query){
      const q = query.trim().toLowerCase();
      if (tbody) {
        for (const row of tbody.rows) {
          if (row.cells.length && row.cells[0].colSpan === 5) continue; // empty state row
          const nameCell = row.cells[0];
          const match = nameCell && nameCell.innerText.toLowerCase().includes(q);
          row.style.display = match ? '' : 'none';
        }
      }
      if (gridSection) {
        const cards = gridSection.querySelectorAll('.inventory-card');
        cards.forEach(card => {
          const title = card.querySelector('.card-title');
          const match = title && title.innerText.toLowerCase().includes(q);
          card.style.display = match ? '' : 'none';
        });
      }
    }

    if (input) {
      input.addEventListener('input', function(){ filterInventory(this.value); });
    }
  </script>
  <div style="height: 56px"></div>
<style>
  :root { --app-footer-height: 68px; }
  html, body { height: auto !important; }
  body { min-height: 100vh; padding-bottom: calc(var(--app-footer-height) + 140px); }
  .app-footer { background-color: #0b2131; color: #e6edf3; }
  .app-footer a { color: #e6edf3; text-decoration: none; }
  .app-footer a:hover { text-decoration: underline; }
  .app-footer-fixed { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
  .app-footer-gradient { height: 4px; background: linear-gradient(90deg, var(--bs-primary, #0d6efd), var(--bs-info, #0dcaf0), var(--bs-success, #198754), var(--bs-warning, #ffc107), var(--bs-danger, #dc3545)); }
  .app-footer-inner { font-size: .95rem; }
</style>
<footer class="app-footer-fixed">
  <div class="app-footer-gradient"></div>
  <div class="app-footer py-3">
    <div class="container text-center app-footer-inner">
      <span>&copy; <script>document.write(new Date().getFullYear());</script> <strong>Supermarket App</strong>. All Rights Reserved.</span>
    </div>
  </div>
</footer>
</body>
</html>
