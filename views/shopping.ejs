<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"> <!-- NOTE: Set character encoding -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- NOTE: Make page responsive on mobile -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- NOTE: Bootstrap CSS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> <!-- NOTE: Bootstrap JS bundle -->
  <title>Supermarket App</title> <!-- NOTE: Browser tab title -->
</head>
<body>
  <%- include('partials/userNav', { active: 'shop' }) %>
  <!-- NOTE: Show user navbar and highlight the 'shop' link -->

  <main>
    <div class="container">
      <p>Welcome, <%= user.username %> (<%= user.role %>)</p>
      <!-- NOTE: Display logged-in username and role -->
      <br>

      <% if (messages && messages.length) { %>
        <!-- NOTE: Show any flash messages (e.g. stock warnings, info) -->
        <div class="alert alert-warning" role="alert">
          <% messages.forEach(function(message) { %>
            <div><%= message %></div>
          <% }); %>
        </div>
        <br>
      <% } %>

      <div class="text-center">
        <h2>Products from Supermarket</h2>
      </div>
      <br>

      <table class="table table-hover small text-center">
        <thead>
          <tr>
            <th width="100">Product Name</th>
            <th width="100">Product Image</th>
            <th width="50">Quantity</th>
            <th width="50">Price</th>
            <th width="50">Quantity to Buy</th>
            <th width="120">Actions</th>
          </tr>
          <!-- NOTE: Basic product listing table header -->
        </thead>

        <tbody>
          <% for(let i=0; i < products.length; i++) { %>
            <!-- NOTE: Loop through each product -->
            <tr>
              <td>
                <a href="/product/<%= products[i].id %>">
                  <%= products[i].productName %>
                </a>
                <!-- NOTE: Product name links to product details page -->
              </td>

              <td>
                <img src="images/<%= products[i].image %>" width="20%">
                <!-- NOTE: Product image thumbnail (path relative to current page) -->
              </td>

              <td><%= products[i].quantity %></td>
              <!-- NOTE: Current stock quantity -->

              <td>$<%= products[i].price.toFixed(2) %></td>
              <!-- NOTE: Product price with 2 decimal places -->

              <td>
                <% const maxPurchaseQty = products[i].quantity; %>
                <!-- NOTE: Max quantity user can purchase = stock -->

                <select
                  class="form-control"
                  onchange="document.getElementById('quantity-<%= products[i].id %>').value = this.value"
                  <%= maxPurchaseQty === 0 ? 'disabled' : '' %>>
                  <!-- NOTE: Dropdown to choose quantity; disabled if out of stock -->

                  <% for (let q = 1; q <= maxPurchaseQty; q++) { %>
                    <option value="<%= q %>"><%= q %></option>
                  <% } %>
                  <!-- NOTE: Options from 1 to available stock -->
                </select>

                <% if (maxPurchaseQty === 0) { %>
                  <small class="text-danger">Out of stock</small>
                  <!-- NOTE: Message shown if product has 0 stock -->
                <% } %>
              </td>

              <td>
                <form
                  action="/add-to-cart/<%= products[i].id %>"
                  method="POST"
                  class="d-flex gap-2 justify-content-center">
                  <!-- NOTE: Form to add selected product to cart -->

                  <input
                    type="hidden"
                    name="quantity"
                    id="quantity-<%= products[i].id %>"
                    value="<%= maxPurchaseQty > 0 ? 1 : 0 %>">
                  <!-- This is a ternary operator (shortcut IF-ELSE). 
                   NOTE: Hidden quantity field; updated by the dropdown via onchange JS -->
                  <!-- NOTE: Defaults to 1 if stock > 0, otherwise 0 -->

                  <button
                    type="submit"
                    name="redirect"
                    value="stay"
                    class="btn btn-outline-primary mt-3">
                    Add to Cart
                  </button>
                  <!-- NOTE: Add item to cart and stay on shopping page -->

                  <button
                    type="submit"
                    name="redirect"
                    value="cart"
                    class="btn btn-primary mt-3">
                    Buy Now
                  </button>
                  <!-- NOTE: Add item to cart then redirect to /cart -->
                </form>
              </td>

            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </main>

  <style>
    html { scroll-behavior: smooth; } /* NOTE: Smooth scrolling for anchor jumps */
    body { min-height: 100vh; display: flex; flex-direction: column; } /* NOTE: Flex layout to push footer down */
    main { flex: 1 0 auto; } /* NOTE: Main grows to fill space */
    footer { flex-shrink: 0; margin-top: auto; } /* NOTE: Footer sticks to bottom */

    .app-footer { background-color: #0b2131; color: #e6edf3; } /* NOTE: Footer background + text color */
    .app-footer a { color: #e6edf3; text-decoration: none; }
    .app-footer a:hover { text-decoration: underline; }

    .app-footer-gradient {
      height: 4px;
      background: linear-gradient(
        90deg,
        var(--bs-primary, #0d6efd),
        var(--bs-info, #0dcaf0),
        var(--bs-success, #198754),
        var(--bs-warning, #ffc107),
        var(--bs-danger, #dc3545)
      );
      /* NOTE: Thin colorful bar above footer */
    }

    .app-footer-inner { font-size: .95rem; } /* NOTE: Footer text size */
  </style>

  <%- include('partials/footer') %>
  <!-- NOTE: Shared footer partial -->

</body>
</html>
