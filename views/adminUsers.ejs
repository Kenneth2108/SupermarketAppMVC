<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"> <!-- Use UTF-8 encoding -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsive on mobile -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap CSS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> <!-- Bootstrap JS bundle -->
  <title>Admin - Users</title>

  <style>
    body { background-color: #f7f7f9; } /* Light grey background */
    .navbar { box-shadow: 0 2px 6px rgba(0,0,0,.05); } /* Subtle navbar shadow */
    .page-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,.06); } /* Card container */
    .page-header { border-bottom: 1px solid #eee; padding-bottom: .75rem; margin-bottom: 1rem; } /* Header divider */
    .table thead th { font-size: .85rem; letter-spacing: .02em; text-transform: uppercase; color: #6c757d; } /* Table header style */
    .search-input { max-width: 360px; } /* Limit search input width */

    /* Unified button style to keep action buttons consistent */
    .app-action-btn {
      min-width: 90px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }

    /* Custom edit button style */
    .app-edit-btn {
      background-color: #6c757d;
      border-color: #6c757d;
      color: #fff;
    }
    .app-edit-btn:hover {
      background-color: #5c636a;
      border-color: #565e64;
      color: #fff;
    }

    /* Footer & layout spacing */
    :root { --app-footer-height: 68px; } /* Footer height variable */
    html, body { height: auto !important; } /* Let height grow with content */
    body { min-height: 100vh; padding-bottom: calc(var(--app-footer-height) + 140px); } /* Prevent footer overlap */

    .app-footer { background-color: #0b2131; color: #e6edf3; } /* Footer background & text */
    .app-footer a { color: #e6edf3; text-decoration: none; }  /* Footer links */
    .app-footer a:hover { text-decoration: underline; }       /* Footer link hover */
    .app-footer-fixed { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; } /* Fixed footer */
    .app-footer-gradient { height: 4px; background: linear-gradient(90deg, var(--bs-primary, #0d6efd), var(--bs-info, #0dcaf0), var(--bs-success, #198754), var(--bs-warning, #ffc107), var(--bs-danger, #dc3545)); } /* Colorful strip above footer */
    .app-footer-inner { font-size: .95rem; } /* Slightly smaller footer text */
  </style>

</head>
<body>
  <!-- Admin navbar, set "users" tab as active -->
  <%- include('partials/adminNav', { active: 'users' }) %>

  <div class="container my-4">
    <div class="page-card p-4">

      <!-- Page header: title + search + Add User button -->
      <div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="m-0">Manage Users</h2>
        <div class="d-flex align-items-center gap-2">
          <!-- Live search input (JS below will filter table rows) -->
          <input id="userSearch" class="form-control form-control-sm search-input" placeholder="Search by name or email..." />
          <!-- Button to go to Add User form -->
          <a class="btn btn-success btn-sm" href="/admin/users/new">Add User</a>
        </div>
      </div>

      <!-- Flash messages from session (e.g. "User updated", "User deleted") -->
      <% if (messages && messages.length) { %>
        <div class="alert alert-info">
          <% messages.forEach(function(m){ %>
            <div><%= m %></div>
          <% }) %>
        </div>
      <% } %>

      <!-- Users table -->
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>ID</th>        <!-- Row index (not DB id) -->
              <th>Username</th>
              <th>Email</th>
              <th>Contact</th>
              <th>Address</th>
              <th>Role</th>
              <th style="width:220px">Actions</th> <!-- Edit / Delete / Role change -->
            </tr>
          </thead>
          <tbody id="usersTableBody">

            <% users.forEach(function(u, idx){ 
              const isSelf = user && String(user.id) === String(u.id);     // Is this row the current logged-in admin?
              const isAdminRow = u.role === 'admin';                       // Is this user an admin?
              const disableRoleForm = isSelf || isAdminRow;                // Cannot change own role or locked admin
              const hasOrders = Number(u.orderCount || 0) > 0;             // Prevent deletion if any orders exist
              const disableDelete = isSelf || hasOrders;                   // Disable delete button if self or has orders
            %>

              <tr>
                <td><%= idx + 1 %></td>               <!-- Simple incrementing index -->
                <td><%= u.username %></td>
                <td><%= u.email %></td>
                <td><%= u.contact %></td>
                <td><%= u.address %></td>

                <!-- Role column: either static badge (locked) or role change form -->
                <td>
                  <% if (disableRoleForm) { %>
                    <!-- Show badge only when role cannot be edited -->
                    <span class="badge bg-secondary text-uppercase"><%= u.role %></span>

                    <% if (isSelf) { %>
                      <small class="d-block text-muted">Own role cannot be changed</small>
                    <% } else if (isAdminRow) { %>
                      <small class="d-block text-muted">Admin role locked</small>
                    <% } %>

                  <% } else { %>
                    <!-- Role update form (only for non-admin, non-self) -->
                    <form action="/admin/users/<%= u.id %>/role" method="POST" class="d-flex gap-2">
                      <select name="role" class="form-select form-select-sm" style="max-width:130px">
                        <option value="user" <%= u.role === 'user' ? 'selected' : '' %>>user</option>
                        <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>admin</option>
                      </select>
                      <button type="submit" class="btn btn-sm btn-primary">Update</button>
                    </form>
                  <% } %>
                </td>

                <!-- Actions column: Edit + Delete -->
                <td>
                  <div class="d-flex gap-2 flex-wrap">

                    <!-- EDIT BUTTON -->
                    <a href="/admin/users/<%= u.id %>/edit"
                       class="btn btn-sm app-action-btn app-edit-btn">
                      Edit
                    </a>

                    <!-- DELETE BUTTON -->
                    <form action="/admin/users/<%= u.id %>/delete"
                          method="POST"
                          onsubmit="return confirm('Delete user <%= u.username %>?');">
                      <button type="submit"
                              class="btn btn-sm btn-danger app-action-btn"
                              <%= disableDelete ? 'disabled' : '' %>>
                        Delete
                      </button>
                    </form>
                    <% if (hasOrders) { %>
                      <small class="text-muted">Has orders - cannot delete</small>
                    <% } %>

                  </div>
                </td>
              </tr>

            <% }) %>

          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Spacer so the fixed footer does not overlay the last content -->
  <div style="height: 56px"></div>

  <!-- Shared footer partial with fixed footer class -->
  <%- include('partials/footer', { footerClass: 'app-footer-fixed' }) %>

  <script>
    // Live search filter for users table
    const uInput = document.getElementById('userSearch');
    const uBody = document.getElementById('usersTableBody');

    if (uInput && uBody) {
      uInput.addEventListener('input', function () {
        const q = this.value.trim().toLowerCase(); // search query
        for (const row of uBody.rows) {
          const name = row.cells[1]?.innerText.toLowerCase() || '';  // Username column
          const email = row.cells[2]?.innerText.toLowerCase() || ''; // Email column
          const match = name.includes(q) || email.includes(q);       // Match if name or email contains query
          row.style.display = match ? '' : 'none';                   // Show / hide row
        }
      });
    }
  </script>

</body>
</html>
