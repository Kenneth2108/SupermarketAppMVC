<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"> <!-- Use UTF-8 encoding -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsive on mobile -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap CSS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> <!-- Bootstrap JS bundle -->
  <title>Admin - Users</title>

  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #f6fbff 0%, #edf3ff 50%, #f5f7fb 100%);
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding-bottom: calc(var(--app-footer-height, 68px) + 120px);
    }
    .navbar { box-shadow: 0 2px 6px rgba(0,0,0,.05); }
    .users-wrapper { max-width: 1280px; }
    .page-card {
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, .12), 0 3px 10px rgba(15, 23, 42, .08);
      padding: 2.5rem;
    }
    .hero-intro {
      background: linear-gradient(135deg, #eef4ff 0%, #fef9ff 50%, #ecf3ff 100%);
      border-radius: 22px;
      padding: 1.5rem 2rem;
      border: 1px solid rgba(99, 123, 255, .15);
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    .hero-intro::after {
      content: "";
      position: absolute;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle at top right, rgba(255, 143, 223, .35), transparent 70%);
      top: -80px;
      right: -60px;
      border-radius: 50%;
      pointer-events: none;
    }
    .hero-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #9b67ff, #6a52ff);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 25px rgba(107, 74, 255, .35);
    }
    .hero-icon svg {
      width: 30px;
      height: 30px;
      stroke: currentColor;
    }
    .hero-text h2 { margin-bottom: .4rem; font-weight: 700; color: #101828; }
    .hero-text p { margin: 0; color: #475467; }
    .hero-badge {
      background: rgba(99, 123, 255, .12);
      color: #4154ff;
      padding: .25rem .85rem;
      border-radius: 999px;
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .page-header {
      border-bottom: 1px solid rgba(148, 163, 184, .3);
      padding-bottom: .75rem;
      margin-bottom: 1.5rem;
    }
    .search-input { max-width: 360px; }
    .btn-pill {
      border-radius: 999px;
      padding: .55rem 1.6rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .4rem;
    }
    .table-modern thead th {
      font-size: .8rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #64748b;
      border-bottom-width: 1px;
      border-color: rgba(148, 163, 184, .4);
    }
    .table-modern tbody tr {
      border-bottom: 1px solid rgba(226, 232, 240, .8);
      transition: background-color .2s ease;
    }
    .table-modern tbody tr:hover { background-color: rgba(99, 123, 255, .04); }
    .role-select { min-width: 160px; border-radius: 12px; }
    .app-action-btn {
      min-width: 90px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .app-edit-btn {
      background-color: #475467;
      border-color: #475467;
      color: #fff;
    }
    .app-edit-btn:hover {
      background-color: #344054;
      border-color: #293445;
      color: #fff;
    }
    :root { --app-footer-height: 68px; }
    html, body { height: auto !important; }
    .app-footer { background-color: #0b2131; color: #e6edf3; }
    .app-footer a { color: #e6edf3; text-decoration: none; }
    .app-footer a:hover { text-decoration: underline; }
    .app-footer-fixed { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
    .app-footer-gradient { height: 4px; background: linear-gradient(90deg, var(--bs-primary, #0d6efd), var(--bs-info, #0dcaf0), var(--bs-success, #198754), var(--bs-warning, #ffc107), var(--bs-danger, #dc3545)); }
    .app-footer-inner { font-size: .95rem; }
  </style>

</head>
<body>
  <!-- Admin navbar, set "users" tab as active -->
  <%- include('partials/adminNav', { active: 'users' }) %>

  <div class="container my-4 users-wrapper">
    <div class="page-card">
      <div class="hero-intro">
        <div class="hero-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M15 12a3 3 0 1 0-6 0 3 3 0 0 0 6 0Z" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M21 21v-1.5a4.5 4.5 0 0 0-4.5-4.5h-9A4.5 4.5 0 0 0 3 19.5V21" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M19 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M9 6a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
        <div class="hero-text">
          <h2>Manage Users</h2>
          <p>Review accounts, adjust roles, and keep your supermarket team organized.</p>
        </div>
        <span class="hero-badge">Team directory</span>
      </div>

      <div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h3 class="m-0 fs-5 text-muted">Directory overview</h3>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <input id="userSearch" class="form-control form-control-sm search-input" placeholder="Search by name or email..." />
          <a class="btn btn-success btn-sm btn-pill" href="/admin/users/new">Add User</a>
        </div>
      </div>

      <!-- Flash messages from session (e.g. "User updated", "User deleted") -->
      <% if (messages && messages.length) { %>
        <div class="alert alert-info">
          <% messages.forEach(function(m){ %>
            <div><%= m %></div>
          <% }) %>
        </div>
      <% } %>

      <!-- Users table -->
      <div class="table-responsive">
        <table class="table align-middle table-modern">
          <thead>
            <tr>
              <th>ID</th>        <!-- Row index (not DB id) -->
              <th>Username</th>
              <th>Email</th>
              <th>Contact</th>
              <th>Address</th>
              <th>Role</th>
              <th style="width:220px">Actions</th> <!-- Edit / Delete / Role change -->
            </tr>
          </thead>
          <tbody id="usersTableBody">

            <% users.forEach(function(u, idx){ 
              const isSelf = user && String(user.id) === String(u.id);     // Is this row the current logged-in admin?
              const isAdminRow = u.role === 'admin';                       // Is this user an admin?
              const disableRoleForm = isSelf || isAdminRow;                // Cannot change own role or locked admin
              const hasOrders = Number(u.orderCount || 0) > 0;             // Prevent deletion if any orders exist
              const disableDelete = isSelf || hasOrders;                   // Disable delete button if self or has orders
            %>

              <tr>
                <td><%= idx + 1 %></td>               <!-- Simple incrementing index -->
                <td><%= u.username %></td>
                <td><%= u.email %></td>
                <td><%= u.contact %></td>
                <td><%= u.address %></td>

                <!-- Role column: either static badge (locked) or role change form -->
                <td>
                  <% if (disableRoleForm) { %>
                    <!-- Show badge only when role cannot be edited -->
                    <span class="badge bg-secondary text-uppercase"><%= u.role %></span>

                    <% if (isSelf) { %>
                      <small class="d-block text-muted">Own role cannot be changed</small>
                    <% } else if (isAdminRow) { %>
                      <small class="d-block text-muted">Admin role locked</small>
                    <% } %>

                  <% } else { %>
                    <!-- Role update form (only for non-admin, non-self) -->
                    <form action="/admin/users/<%= u.id %>/role" method="POST" class="d-flex gap-2">
                      <select name="role" class="form-select form-select-sm role-select">
                        <option value="user" <%= u.role === 'user' ? 'selected' : '' %>>user</option>
                        <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>admin</option>
                      </select>
                      <button type="submit" class="btn btn-sm btn-primary">Update</button>
                    </form>
                  <% } %>
                </td>

                <!-- Actions column: Edit + Delete -->
                <td>
                  <div class="d-flex gap-2 flex-wrap">

                    <!-- EDIT BUTTON -->
                    <a href="/admin/users/<%= u.id %>/edit"
                       class="btn btn-sm app-action-btn app-edit-btn">
                      Edit
                    </a>

                    <!-- DELETE BUTTON -->
                    <form action="/admin/users/<%= u.id %>/delete"
                          method="POST"
                          onsubmit="return confirm('Delete user <%= u.username %>?');">
                      <button type="submit"
                              class="btn btn-sm btn-danger app-action-btn"
                              <%= disableDelete ? 'disabled' : '' %>>
                        Delete
                      </button>
                    </form>
                    <% if (hasOrders) { %>
                      <small class="text-muted">Has orders - cannot delete</small>
                    <% } %>

                  </div>
                </td>
              </tr>

            <% }) %>

          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Spacer so the fixed footer does not overlay the last content -->
  <div style="height: 56px"></div>

  <!-- Shared footer partial with fixed footer class -->
  <%- include('partials/footer', { footerClass: 'app-footer-fixed' }) %>

  <script>
    // Live search filter for users table
    const uInput = document.getElementById('userSearch');
    const uBody = document.getElementById('usersTableBody');

    if (uInput && uBody) {
      uInput.addEventListener('input', function () {
        const q = this.value.trim().toLowerCase(); // search query
        for (const row of uBody.rows) {
          const name = row.cells[1]?.innerText.toLowerCase() || '';  // Username column
          const email = row.cells[2]?.innerText.toLowerCase() || ''; // Email column
          const match = name.includes(q) || email.includes(q);       // Match if name or email contains query
          row.style.display = match ? '' : 'none';                   // Show / hide row
        }
      });
    }
  </script>

</body>
</html>
